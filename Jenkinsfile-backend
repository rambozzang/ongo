// onGo - Backend Jenkins Pipeline
// Git push시 자동으로 백엔드 빌드 + 배포

pipeline {
    agent any

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '20'))
        disableConcurrentBuilds()
    }

     triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'ref', value: '$.ref'],
                [key: 'changed_files', value: '$.commits[*].["modified","added","removed"][*]']
            ],
            regexpFilterText: '$changed_files',
            regexpFilterExpression: '.*(backend)/.*',  // backend/ 변경 시 트리거
            token: 'ongo-backend'
        )
    }

    stages {
        stage('Build Backend') {
            steps {
                dir('backend') {
                    sh './gradlew :onGo-api:bootJar -x test --no-daemon'
                }
            }
        }

        stage('Deploy Backend') {
            steps {
                script {
                    echo 'Syncing backend workspace to production source directory...'
                    sh 'mkdir -p /data/ongo/src/backend /data/ongo/src/deploy'

                    // backend, deploy 폴더만 동기화하여 프론트엔드 결과물 보존
                    sh 'rsync -av --delete --exclude=".git" backend/ /data/ongo/src/backend/'
                    sh 'rsync -av --delete --exclude=".git" deploy/ /data/ongo/src/deploy/'

                    echo 'Executing deployment script for backend...'
                    sh 'JENKINS_NODE_COOKIE=dontKillMe bash /data/ongo/src/deploy/deploy.sh backend --skip-git --skip-build'
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }

        success {
            echo 'Backend build and deploy completed successfully!'
        }

        failure {
            echo 'Backend build or deploy failed!'
        }
    }
}
